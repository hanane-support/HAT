<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>웹훅 관리 대시보드 | Vultr</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 폰트 및 스크롤바 */
        body { font-family: 'Inter', sans-serif; }
        .log-container::-webkit-scrollbar { width: 8px; }
        .log-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; }
        
        /* 탭 스타일 */
        .tab-button.active { 
            background-color: #1f2937; /* Gray-800 */
            color: #a7f3d0; /* Lime-200 */
            border-left-color: #4ade80 !important; /* Lime-400 */
        }

        /* 반응형 그리드 */
        .main-grid { grid-template-columns: 250px 1fr; }
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            #sidebar { display: none !important; }
            #mobile-nav { display: block !important; }
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">

    <!-- 모바일 탭 네비게이션 -->
    <div id="mobile-nav" class="md:hidden p-4 bg-gray-900 border-b border-gray-700 hidden">
        <select id="mobile-tab-select" class="w-full p-2 bg-gray-800 text-white rounded border border-gray-700">
            <option value="dashboard">🔔 대시보드</option>
            <option value="domain">🌐 도메인 연동</option>
            <option value="security">🔒 보안</option>
        </select>
    </div>

    <!-- 메인 레이아웃: 2열 그리드 (Sidebar + Content) -->
    <div class="main-grid min-h-screen">
        
        <!-- 왼쪽 세로 탭 메뉴 (Sidebar) -->
        <aside id="sidebar" class="bg-gray-900 border-r border-gray-800 p-4 sticky top-0 h-screen">
            <h1 class="text-xl font-bold mb-6 text-sky-400">Vultr Webhook 설정</h1>
            <nav class="space-y-2">
                <button class="tab-button active w-full text-left p-3 rounded-r-lg border-l-4 border-l-lime-400 transition duration-150 text-gray-300 hover:bg-gray-800" data-tab="dashboard">
                    🔔 웹훅 리스너 대시보드
                </button>
                <button class="tab-button w-full text-left p-3 rounded-r-lg border-l-4 border-l-gray-800 transition duration-150 text-gray-300 hover:bg-gray-800" data-tab="domain">
                    🌐 도메인 연동
                </button>
                <button class="tab-button w-full text-left p-3 rounded-r-lg border-l-4 border-l-gray-800 transition duration-150 text-gray-300 hover:bg-gray-800" data-tab="security">
                    🔒 보안
                </button>
            </nav>
            <div class="mt-8 pt-4 border-t border-gray-700 text-xs text-gray-500">
                <p>Status: <span id="deployment-status" class="text-red-500 font-semibold">Connecting...</span></p>
                <p>Last Saved: <span id="last-saved-time">N/A</span></p>
            </div>
        </aside>

        <!-- 오른쪽 콘텐츠 영역 -->
        <main class="p-4 md:p-8 relative">
            
            <header class="mb-6 pb-3 border-b border-gray-700 flex justify-between items-center">
                <h2 id="page-title" class="text-3xl font-extrabold text-lime-400">🔔 웹훅 리스너 대시보드</h2>
                <button id="save-settings-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    설정 저장
                </button>
            </header>


            <!-- 1. 대시보드 (기본 활성) -->
            <div id="dashboard" class="tab-content active space-y-6">
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 shadow-2xl">
                    <h3 class="text-xl font-bold mb-4 text-sky-300">실시간 웹훅 수신 로그</h3>
                    <!-- 웹훅 URL 안내 -->
                    <div class="p-3 mb-4 bg-gray-800 border border-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400">
                            웹훅 URL (도메인 연동 후): 
                            <code id="webhook-url-display" class="bg-gray-900 text-yellow-400 p-1 rounded">http://[SERVER_IP]:8000/webhook</code>
                            <button onclick="copyToClipboard('http://[SERVER_IP]:8000/webhook')" class="ml-2 text-xs text-sky-400 hover:text-sky-300">
                                [복사]
                            </button>
                        </p>
                    </div>

                    <div id="log-list" class="log-container space-y-3 p-4 bg-gray-800 border border-gray-700 rounded-lg h-[60vh] overflow-y-auto">
                        <p class="text-gray-500 text-center py-10">로그를 가져오는 중...</p>
                    </div>
                </div>
            </div>

            <!-- 2. 도메인 연동 탭 -->
            <div id="domain" class="tab-content space-y-6 hidden">
                <h3 class="text-2xl font-bold mb-4 text-yellow-400">🌐 도메인 연동 설정</h3>
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 shadow-2xl space-y-4">
                    <p class="text-gray-400">
                        Vultr 서버 IP로 연결된 도메인을 입력하고 연동하세요. Caddy를 통해 HTTPS 인증서가 자동 발급됩니다.
                    </p>
                    <div class="flex flex-col space-y-2">
                        <label for="domain-input" class="text-lime-400 font-semibold">도메인 입력 (예: webhook.mytrading.com)</label>
                        <input type="text" id="domain-input" placeholder="도메인 주소" class="p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:ring-lime-500 focus:border-lime-500">
                    </div>
                    <button id="link-domain-btn" class="w-full bg-lime-600 hover:bg-lime-700 text-black font-bold py-3 px-4 rounded-lg transition duration-150">
                        도메인 연동 및 HTTPS 적용
                    </button>
                    <div id="domain-status-message" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
                </div>
            </div>

            <!-- 3. 보안 탭 -->
            <div id="security" class="tab-content space-y-6 hidden">
                <h3 class="text-2xl font-bold mb-4 text-red-400">🔒 웹훅 보안 설정 (Caddy 방화벽)</h3>
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 shadow-2xl space-y-4">
                    <p class="text-gray-400">
                        **도메인 연동 후**에만 설정 가능합니다. TradingView 공식 IP와 현재 접속 중인 로컬 IP만 허용하도록 설정합니다.
                    </p>
                    <div class="flex flex-col space-y-2">
                        <label for="local-ip-input" class="text-sky-400 font-semibold">내 로컬 IP (관리자 접근 허용)</label>
                        <input type="text" id="local-ip-input" placeholder="자동 감지 중..." class="p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <button id="apply-security-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150" disabled>
                        보안 (IP 제한) 적용하기
                    </button>
                    <div id="security-status-message" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- 알림 모달 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm border border-gray-700">
            <h4 id="modal-title" class="text-xl font-bold mb-4 text-yellow-400">알림</h4>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-ok-btn" class="bg-sky-600 hover:bg-sky-700 text-white py-2 px-4 rounded-lg">확인</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 상태 변수
        let settings_status = {}; 
        let localIP = "";

        // UI 요소
        const logList = document.getElementById('log-list');
        const saveBtn = document.getElementById('save-settings-btn');
        const linkDomainBtn = document.getElementById('link-domain-btn');
        const applySecurityBtn = document.getElementById('apply-security-btn');
        const domainInput = document.getElementById('domain-input');
        const localIpInput = document.getElementById('local-ip-input');
        const domainStatusMsg = document.getElementById('domain-status-message');
        const securityStatusMsg = document.getElementById('security-status-message');
        const deploymentStatusSpan = document.getElementById('deployment-status');
        const lastSavedTimeSpan = document.getElementById('last-saved-time');
        const pageTitle = document.getElementById('page-title');
        const webhookUrlDisplay = document.getElementById('webhook-url-display');
        
        // --- 유틸리티 함수 ---

        // 커스텀 알림 (alert 대체)
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
            document.getElementById('modal-ok-btn').onclick = () => {
                document.getElementById('modal').classList.add('hidden');
                document.getElementById('modal').classList.remove('flex');
            };
        }

        // 텍스트 클립보드 복사
        window.copyToClipboard = function(text) {
            // 도메인 연동 전에는 IP 기반 URL을 복사
            if (!settings_status.domain_linked && text.includes("[YOUR_DOMAIN]")) {
                text = webhookUrlDisplay.textContent;
            }
            
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showModal('복사 완료', '웹훅 URL이 클립보드에 복사되었습니다.');
        }

        // 상태 메시지 업데이트
        function updateStatusMessage(element, message, type) {
            element.textContent = message;
            element.className = 'mt-4 p-3 rounded-lg text-sm';
            element.classList.remove('hidden');
            if (type === 'success') {
                element.classList.add('bg-green-900', 'text-lime-400');
            } else if (type === 'error') {
                element.classList.add('bg-red-900', 'text-red-400');
            } else { // info
                element.classList.add('bg-gray-700', 'text-gray-300');
            }
        }
        
        // UI 상태 업데이트
        function updateUIState() {
            const domain = settings_status.domain_name || "";
            domainInput.value = domain;
            localIpInput.value = localIP;
            
            const isDomainLinked = settings_status.domain_linked;
            const isSecurityApplied = settings_status.security_applied;

            // 웹훅 URL 업데이트
            if (isDomainLinked) {
                webhookUrlDisplay.textContent = `https://${domain}/webhook`;
                // 클립보드 복사 버튼의 onclick 속성도 업데이트 필요
                const copyButton = document.querySelector('#webhook-url-display + button');
                copyButton.setAttribute('onclick', `copyToClipboard('https://${domain}/webhook')`);
            } else {
                 // 서버 IP를 알 수 없으므로, 플레이스홀더를 유지합니다. (Vultr IP로 대체해야 함)
                 webhookUrlDisplay.textContent = document.URL.replace("/admin", "/webhook").replace(":8000", domain ? "" : ":8000");
                 // 임시 URL 복사를 위한 처리 (서버 IP를 동적으로 가져오는 것은 복잡하므로, URL을 그대로 복사하도록 설정)
                 const currentUrl = document.URL.split("/admin")[0] + "/webhook";
                 const copyButton = document.querySelector('#webhook-url-display + button');
                 copyButton.setAttribute('onclick', `copyToClipboard('${currentUrl}')`);
            }


            // 보안 버튼 활성화/비활성화
            applySecurityBtn.disabled = !isDomainLinked || isSecurityApplied;
            
            applySecurityBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-gray-600');
            if (isSecurityApplied) {
                applySecurityBtn.classList.add('bg-gray-600', 'hover:bg-gray-600');
                applySecurityBtn.textContent = "보안 적용됨";
            } else if (isDomainLinked) {
                applySecurityBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                applySecurityBtn.textContent = "보안 적용하기";
            } else {
                applySecurityBtn.classList.add('bg-gray-600');
                applySecurityBtn.textContent = "도메인 연동이 필요합니다";
            }

            // 서버 상태 표시
            deploymentStatusSpan.textContent = isDomainLinked ? (isSecurityApplied ? 'Secure' : 'Linked') : 'Not Configured';
            deploymentStatusSpan.className = isSecurityApplied ? 'text-green-500 font-semibold' : (isDomainLinked ? 'text-yellow-400 font-semibold' : 'text-red-500 font-semibold');

            // 마지막 저장 시간
            lastSavedTimeSpan.textContent = settings_status.last_saved_time || 'N/A';
        }

        // --- 데이터 Fetch 및 렌더링 ---

        // 웹훅 로그 Fetch
        async function fetchWebhookData() {
            try {
                const response = await fetch('/data');
                const data = await response.json();
                renderLogList(data);
            } catch (error) {
                console.error('로그 데이터를 불러오는 중 오류 발생:', error);
                logList.innerHTML = '<p class="text-red-500 text-center py-10">로그 데이터를 불러올 수 없습니다. 서버(Gunicorn) 상태를 확인하세요.</p>';
            }
        }

        function renderLogList(data) {
            if (data.length === 0) {
                logList.innerHTML = '<p class="text-gray-500 text-center py-10">웹훅 메시지를 기다리는 중...</p>';
                return;
            }

            const newHTML = data.map(item => {
                const messageHtml = item.message.split('\n').map(line => 
                    `<span class="text-lime-400">${line}</span>`
                ).join('<br>');
                
                return `
                    <div class="p-3 border-b border-gray-700 hover:bg-gray-800 transition duration-150 rounded-lg">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start">
                            <div class="text-sm font-semibold text-sky-400 mb-1 md:mb-0">
                                <span class="text-gray-500">[</span>${item.timestamp}<span class="text-gray-500">]</span>
                            </div>
                            <pre class="text-white text-sm whitespace-pre-wrap break-words mt-1 md:mt-0 max-w-full overflow-hidden">
                                ${messageHtml}
                            </pre>
                        </div>
                    </div>
                `;
            }).join('');
            logList.innerHTML = newHTML;
        }

        // 서버 상태 Fetch (가장 중요)
        async function fetchServerStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                settings_status = status;
                updateUIState();
            } catch (error) {
                console.error('서버 상태를 불러오는 중 오류 발생:', error);
            }
        }

        // 로컬 IP 자동 감지 (비동기)
        async function fetchLocalIP() {
            try {
                // 외부 서비스를 사용하여 클라이언트의 Public IP를 가져옵니다.
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                localIP = data.ip;
                localIpInput.value = localIP;
            } catch (error) {
                console.warn('로컬 IP 자동 감지 실패:', error);
                localIpInput.placeholder = "로컬 IP 자동 감지 실패, 수동 입력 필요";
            }
        }

        // --- 이벤트 핸들러 ---

        // 탭 변경
        function changeTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-l-lime-400');
                btn.classList.add('border-l-gray-800');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active', 'border-l-lime-400');
                    btn.classList.remove('border-l-gray-800');
                    pageTitle.textContent = btn.textContent;
                }
            });
            
            document.getElementById('mobile-tab-select').value = tabId;
        }

        // 도메인 연동 버튼 클릭
        linkDomainBtn.addEventListener('click', async () => {
            const domain = domainInput.value.trim();
            if (!domain) {
                return showModal('경고', '도메인을 입력해 주세요.');
            }

            updateStatusMessage(domainStatusMsg, '도메인 연동 및 Caddy 재시작 중...', 'info');
            try {
                const response = await fetch('/api/link_domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain: domain })
                });
                const result = await response.json();
                
                if (response.ok) {
                    updateStatusMessage(domainStatusMsg, result.message, 'success');
                    // Caddy 재시작 후 HTTPS가 활성화되므로, 잠시 후 URL을 HTTPS로 안내
                    setTimeout(() => showModal('성공 알림', `도메인 연동 성공! 이제부터 **https://${domain}/admin** 으로 접속해 주세요.`), 1000);
                    await fetchServerStatus(); // 상태 새로고침
                } else {
                    updateStatusMessage(domainStatusMsg, `오류: ${result.detail}`, 'error');
                }
            } catch (error) {
                console.error('도메인 연동 오류:', error);
                updateStatusMessage(domainStatusMsg, `서버 연결 오류: ${error.message}`, 'error');
            }
        });

        // 보안 적용 버튼 클릭
        applySecurityBtn.addEventListener('click', async () => {
            if (!settings_status.domain_linked) {
                return showModal('경고', '도메인 연동이 먼저 필요합니다.');
            }
            const localIp = localIpInput.value.trim();
            if (!localIp) {
                 return showModal('경고', '로컬 IP를 입력하거나 자동 감지되도록 기다려 주세요.');
            }

            updateStatusMessage(securityStatusMsg, '보안 Caddyfile 작성 및 Caddy 재시작 중...', 'info');
            try {
                const response = await fetch('/api/apply_security', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ local_ip: localIp })
                });
                const result = await response.json();
                
                if (response.ok) {
                    updateStatusMessage(securityStatusMsg, result.message, 'success');
                    await fetchServerStatus(); // 상태 새로고침
                } else {
                    updateStatusMessage(securityStatusMsg, `오류: ${result.detail}`, 'error');
                }
            } catch (error) {
                console.error('보안 적용 오류:', error);
                updateStatusMessage(securityStatusMsg, `서버 연결 오류: ${error.message}`, 'error');
            }
        });
        
        // 설정 저장 버튼 클릭 (현재는 상태 업데이트만)
        saveBtn.addEventListener('click', async () => {
             try {
                const response = await fetch('/api/save_settings', { method: 'POST' });
                const result = await response.json();
                showModal('설정 저장', result.message);
                await fetchServerStatus();
            } catch (error) {
                showModal('저장 오류', '설정 저장 중 오류가 발생했습니다.');
            }
        });


        // --- 초기화 ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // 탭 핸들러 등록
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => changeTab(button.dataset.tab));
            });
            document.getElementById('mobile-tab-select').addEventListener('change', (e) => {
                changeTab(e.target.value);
            });
            
            // 초기 데이터 로드 및 타이머 시작
            fetchServerStatus();
            fetchLocalIP();
            setInterval(fetchWebhookData, 5000); // 5초마다 로그 업데이트
            setInterval(fetchServerStatus, 10000); // 10초마다 서버 상태 업데이트
            
            // 초기 탭 설정
            changeTab('dashboard');
        });
    </script>
</body>
</html>
